package com.dayab.widget;

import java.awt.AWTException;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.GradientPaint;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.MenuItem;
import java.awt.PopupMenu;
import java.awt.RenderingHints;
import java.awt.SystemTray;
import java.awt.Toolkit;
import java.awt.TrayIcon;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionAdapter;
import java.awt.image.BufferedImage;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JProgressBar;
import javax.swing.JSeparator;
import javax.swing.SwingUtilities;
import javax.swing.Timer;

/**
 * –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞ Swing
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ª—é–±–æ–π Java –≤–µ—Ä—Å–∏–µ–π
 */
public class SwingWidgetApplication extends JFrame {
    
    private JLabel timeLabel;
    private JLabel dateLabel;
    private JLabel statusLabel;
    private JProgressBar progressBar;
    private Timer timer;
    private Timer progressTimer;
    private SystemTray systemTray;
    private TrayIcon trayIcon;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –æ–∫–Ω–∞
    private int mouseX, mouseY;
    
    public SwingWidgetApplication() {
        initializeUI();
        initSystemTray();
        startTimeUpdater();
        setupWindowDragging();
    }
    
    private void initializeUI() {
        setTitle("GOVNOScreamer Widget");
        setDefaultCloseOperation(JFrame.HIDE_ON_CLOSE);
        setResizable(false);
        setAlwaysOnTop(true);
        setUndecorated(true); // –£–±–∏—Ä–∞–µ–º –¥–µ–∫–æ—Ä–∞—Ü–∏–∏ –æ–∫–Ω–∞
        setBackground(new Color(0, 0, 0, 0)); // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
        
        // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–Ω–µ–ª—å —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
        JPanel mainPanel = new JPanel() {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2d = (Graphics2D) g;
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                GradientPaint gradient = new GradientPaint(
                    0, 0, new Color(102, 126, 234),
                    getWidth(), getHeight(), new Color(118, 75, 162)
                );
                g2d.setPaint(gradient);
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 15, 15);
            }
        };
        
        mainPanel.setOpaque(false); // –î–µ–ª–∞–µ–º –ø–∞–Ω–µ–ª—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π
        mainPanel.setLayout(new BoxLayout(mainPanel, BoxLayout.Y_AXIS));
        mainPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        JLabel titleLabel = new JLabel("üöÄ –ì–û–í–ù–û –°–∫—Ä–∏–º–µ—Ä", JLabel.CENTER);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 24));
        titleLabel.setForeground(Color.WHITE);
        titleLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        
        // –í—Ä–µ–º—è
        timeLabel = new JLabel("", JLabel.CENTER);
        timeLabel.setFont(new Font("Arial", Font.BOLD, 18));
        timeLabel.setForeground(Color.WHITE);
        timeLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        
        // –î–∞—Ç–∞
        dateLabel = new JLabel("", JLabel.CENTER);
        dateLabel.setFont(new Font("Arial", Font.PLAIN, 14));
        dateLabel.setForeground(new Color(224, 224, 224));
        dateLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        
        // –°—Ç–∞—Ç—É—Å
        statusLabel = new JLabel("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ", JLabel.CENTER);
        statusLabel.setFont(new Font("Arial", Font.PLAIN, 12));
        statusLabel.setForeground(new Color(144, 238, 144));
        statusLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
        progressBar = new JProgressBar(0, 100);
        progressBar.setValue(0);
        progressBar.setStringPainted(true);
        progressBar.setMaximumSize(new Dimension(200, 25));
        progressBar.setAlignmentX(Component.CENTER_ALIGNMENT);
        
        // –ö–Ω–æ–ø–∫–∏
        JPanel buttonPanel = new JPanel(new FlowLayout());
        buttonPanel.setOpaque(false); // –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫
        
        JButton startButton = createStyledButton("–ó–∞–ø—É—Å—Ç–∏—Ç—å", new Color(76, 175, 80));
        JButton stopButton = createStyledButton("–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", new Color(244, 67, 54));
        JButton settingsButton = createStyledButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", new Color(33, 150, 243));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        startButton.addActionListener(e -> startProcess());
        stopButton.addActionListener(e -> stopProcess());
        settingsButton.addActionListener(e -> showSettings());
        
        buttonPanel.add(startButton);
        buttonPanel.add(stopButton);
        buttonPanel.add(settingsButton);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        mainPanel.add(titleLabel);
        mainPanel.add(Box.createVerticalStrut(10));
        mainPanel.add(timeLabel);
        mainPanel.add(dateLabel);
        mainPanel.add(Box.createVerticalStrut(15));
        mainPanel.add(new JSeparator());
        mainPanel.add(Box.createVerticalStrut(15));
        mainPanel.add(statusLabel);
        mainPanel.add(Box.createVerticalStrut(10));
        mainPanel.add(progressBar);
        mainPanel.add(Box.createVerticalStrut(15));
        mainPanel.add(buttonPanel);
        
        add(mainPanel);
        
        // –†–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è
        setSize(320, 280);
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
        setLocation(screenSize.width - getWidth() - 30, 30);
        
        updateTime(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    }
    
    private JButton createStyledButton(String text, Color color) {
        JButton button = new JButton(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g;
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                
                Color bgColor = getModel().isPressed() ? color.darker() : 
                               getModel().isRollover() ? color.brighter() : color;
                
                g2d.setColor(bgColor);
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 20, 20);
                
                g2d.setColor(Color.WHITE);
                FontMetrics fm = g2d.getFontMetrics();
                int x = (getWidth() - fm.stringWidth(getText())) / 2;
                int y = (getHeight() + fm.getAscent()) / 2 - 2;
                g2d.drawString(getText(), x, y);
            }
        };
        
        button.setFont(new Font("Arial", Font.BOLD, 10));
        button.setForeground(Color.WHITE);
        button.setPreferredSize(new Dimension(80, 30));
        button.setContentAreaFilled(false);
        button.setBorderPainted(false);
        button.setFocusPainted(false);
        
        return button;
    }
    
    private void initSystemTray() {
        if (!SystemTray.isSupported()) {
            System.out.println("SystemTray –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            return;
        }
        
        systemTray = SystemTray.getSystemTray();
        
        // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Ç—Ä–µ—è
        BufferedImage image = new BufferedImage(16, 16, BufferedImage.TYPE_INT_ARGB);
        Graphics2D g = image.createGraphics();
        g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        g.setColor(new Color(102, 126, 234));
        g.fillOval(0, 0, 16, 16);
        g.setColor(Color.WHITE);
        g.setFont(new Font("Arial", Font.BOLD, 10));
        g.drawString("G", 5, 12);
        g.dispose();
        
        PopupMenu popup = new PopupMenu();
        MenuItem showItem = new MenuItem("–ü–æ–∫–∞–∑–∞—Ç—å");
        MenuItem exitItem = new MenuItem("–í—ã—Ö–æ–¥");
        
        showItem.addActionListener(e -> {
            setVisible(true);
            setState(JFrame.NORMAL);
            toFront();
        });
        
        exitItem.addActionListener(e -> {
            System.exit(0);
        });
        
        popup.add(showItem);
        popup.addSeparator();
        popup.add(exitItem);
        
        trayIcon = new TrayIcon(image, "GOVNOScreamer Widget", popup);
        trayIcon.setImageAutoSize(true);
        
        try {
            systemTray.add(trayIcon);
        } catch (AWTException e) {
            System.out.println("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É –≤ —Ç—Ä–µ–π");
        }
    }
    
    private void startTimeUpdater() {
        timer = new Timer(1000, e -> updateTime());
        timer.start();
    }
    
    private void updateTime() {
        LocalDateTime now = LocalDateTime.now();
        timeLabel.setText(now.format(DateTimeFormatter.ofPattern("HH:mm:ss")));
        dateLabel.setText(now.format(DateTimeFormatter.ofPattern("dd MMMM yyyy")));
    }
    
    private void startProcess() {
        statusLabel.setText("–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω");
        statusLabel.setForeground(new Color(255, 215, 0)); // –ó–æ–ª–æ—Ç–æ–π
        
        progressBar.setValue(0);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
        if (progressTimer != null) {
            progressTimer.stop();
        }
        
        progressTimer = new Timer(50, new ActionListener() {
            int progress = 0;
            
            @Override
            public void actionPerformed(ActionEvent e) {
                progress++;
                progressBar.setValue(progress);
                
                if (progress >= 100) {
                    progressTimer.stop();
                    statusLabel.setText("–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω");
                    statusLabel.setForeground(new Color(144, 238, 144)); // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
                }
            }
        });
        progressTimer.start();
    }
    
    private void stopProcess() {
        if (progressTimer != null) {
            progressTimer.stop();
        }
        
        statusLabel.setText("–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
        statusLabel.setForeground(new Color(244, 67, 54)); // –ö—Ä–∞—Å–Ω—ã–π
        progressBar.setValue(0);
    }
    
    private void showSettings() {
        JOptionPane.showMessageDialog(
            this,
            "–ó–¥–µ—Å—å –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞!\n\n" +
            "‚Ä¢ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫\n" +
            "‚Ä¢ –ü–æ–∑–∏—Ü–∏—è –æ–∫–Ω–∞\n" +
            "‚Ä¢ –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞\n" +
            "‚Ä¢ –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞",
            JOptionPane.INFORMATION_MESSAGE
        );
    }
    
    private void setupWindowDragging() {
        addMouseListener(new MouseAdapter() {
            @Override
            public void mousePressed(MouseEvent e) {
                mouseX = e.getX();
                mouseY = e.getY();
            }
            
            @Override
            public void mouseClicked(MouseEvent e) {
                // –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
                if (e.getButton() == MouseEvent.BUTTON3) {
                    showContextMenu(e);
                }
            }
        });
        
        addMouseMotionListener(new MouseMotionAdapter() {
            @Override
            public void mouseDragged(MouseEvent e) {
                int dx = e.getX() - mouseX;
                int dy = e.getY() - mouseY;
                setLocation(getX() + dx, getY() + dy);
            }
        });
    }
    
    private void showContextMenu(MouseEvent e) {
        javax.swing.JPopupMenu contextMenu = new javax.swing.JPopupMenu();
        
        javax.swing.JMenuItem hideItem = new javax.swing.JMenuItem("–°–∫—Ä—ã—Ç—å –≤ —Ç—Ä–µ–π");
        javax.swing.JMenuItem settingsItem = new javax.swing.JMenuItem("–ù–∞—Å—Ç—Ä–æ–π–∫–∏");
        javax.swing.JMenuItem exitItem = new javax.swing.JMenuItem("–í—ã—Ö–æ–¥");
        
        hideItem.addActionListener(ev -> setVisible(false));
        settingsItem.addActionListener(ev -> showSettings());
        exitItem.addActionListener(ev -> System.exit(0));
        
        contextMenu.add(hideItem);
        contextMenu.add(settingsItem);
        contextMenu.addSeparator();
        contextMenu.add(exitItem);
        
        contextMenu.show(this, e.getX(), e.getY());
    }
    
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            SwingWidgetApplication app = new SwingWidgetApplication();
            app.setVisible(true);
        });
    }
} 